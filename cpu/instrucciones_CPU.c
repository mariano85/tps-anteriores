/*
 * instrucciones_CPU.c
 *
 *  Created on: 30/09/2014
 *      Author: utnso
 */

#include "cpu.h"
#include "instrucciones_CPU.h"

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////// Instrucciones de la CPU////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void instruccion_LOAD(int32_t *Registro,int32_t Numero){
	*Registro = Numero;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void instruccion_GETM(int32_t *Registro1,int32_t *Registro2){

	*Registro1 = *Registro2;

}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/*
void instruccion_SETM(int32_t numero,int32_t registro1,int32_t registro2){




}
*/
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/*
void instruccion_MOVR(int Registro1,int Registro2){


	Registro1 = Registro2;

}
*/
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void instruccion_ADDR(int32_t *Registro1,int32_t *Registro2){

	*Registro1 = *Registro1 + *Registro2;

}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void instruccion_SUBR(int32_t *Registro1,int32_t *Registro2){


	*Registro1 = *Registro1 - *Registro2;


}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void instruccion_MULR(int32_t *Registro1,int32_t *Registro2){


	*Registro1 = *Registro1 * *Registro2;


}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


void instruccion_MODR(int32_t *Registro1,int32_t *Registro2){


	*Registro1 = *Registro1 % *Registro2;


}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void instruccion_DIVR(int32_t *Registro1,int *Registro2){

	if(Registro2 == 0){

		EFLAG = ZERO_DIV;

	}else{

		*Registro1 = *Registro1 / *Registro2;

	}

}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void instruccion_INCR(int32_t *Registro1){

	*Registro1 = *Registro1 + 1;

}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void instruccion_DECR(int32_t *Registro1){


	*Registro1 = *Registro1 - 1;

}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void instruccion_COMP(int32_t *Registro1,int32_t *Registro2){

	int aux_2;

	if(Registro1 == Registro2){

		aux_2 = 1;
	}else{

		aux_2 = 0 ;

	}

	*Registro1 = aux_2;

}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void instruccion_CGEQ(int32_t *Registro1,int32_t *Registro2){



	if(*Registro1 >= *Registro2){

		A = 1;
	}else{

		A = 0;

	}


}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void instruccion_CLEQ(int32_t *Registro1,int32_t *Registro2){



	if(*Registro1 <= *Registro2){

		A = 1;

	}else{

		A = 0;

	}

}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void instruccion_GOTO(int32_t *Registro){

		program_counter =aumentarProgramCounter(TCB->base_segmento_codigo,*Registro);

}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void instruccion_JMPZ(int32_t Direccion){

	if(A == 0){

		program_counter = Direccion;

	}
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void instruccion_JPNZ(int32_t Direccion){


	if(A != 0){

		program_counter = Direccion;

		}
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void instruccion_INTE(int32_t Direccion){

	systemCall = 1; //Se produjo un llamado al sistema

	cargar_registros_TCB();

	// Envio TCB
	t_contenido mensaje_para_mandar_TCB;
	memset(mensaje_para_mandar_TCB,0,sizeof(t_contenido));
	strcpy(mensaje_para_mandar_TCB,string_from_format("[%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d]",TCB->pid,TCB->tid,TCB->indicador_modo_kernel,TCB->base_segmento_codigo,TCB->tamanio_segmento_codigo,TCB->puntero_instruccion,TCB->base_stack,TCB->cursor_stack,TCB->registros_de_programacion.A,TCB->registros_de_programacion.B,TCB->registros_de_programacion.C,TCB->registros_de_programacion.D,TCB->registros_de_programacion.E));
	enviarMensaje(newFD,CPU_TO_KERNEL_INTERRUPCION_POR_BLOK_BLOQUEAR_PROCESO,mensaje_para_mandar_TCB,logs);



}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void instruccion_MALC(){

	t_contenido mensaje_para_la_msp;
	memset(mensaje_para_la_msp,0,sizeof(t_contenido));
	strcpy(mensaje_para_la_msp, string_from_format("[%d,%d]",TCB->pid,A));
	enviarMensaje(socketMSP,MSP_TO_KERNEL_HANDSHAKE_OK,mensaje_para_la_msp,logs);

	t_contenido  mensaje_para_recibir_info_de_la_msp;
	recibirMensaje(socketMSP,mensaje_para_recibir_info_de_la_msp,logs);

	int32_t direccion = atoi(mensaje_para_recibir_info_de_la_msp);

	log_info(logs,"el valor de la direccion %d",direccion);

	if(direccion == EXIT_FAILURE){

		// Envio TCB
		t_contenido mensaje_para_mandar_TCB;
		memset(mensaje_para_mandar_TCB,0,sizeof(t_contenido));
		strcpy(mensaje_para_mandar_TCB,string_from_format("[%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d]",TCB->pid,TCB->tid,TCB->indicador_modo_kernel,TCB->base_segmento_codigo,TCB->tamanio_segmento_codigo,TCB->puntero_instruccion,TCB->base_stack,TCB->cursor_stack,TCB->registros_de_programacion.A,TCB->registros_de_programacion.B,TCB->registros_de_programacion.C,TCB->registros_de_programacion.D,TCB->registros_de_programacion.E));
		enviarMensaje(newFD,CPU_TO_KERNEL_END_PROC_ERROR,mensaje_para_mandar_TCB,logs);
	}




}
/////////////////////////////////////////////////////////////////////////////////////////////////

void instruccion_FREE(){

	log_info(logs,"entro al FREE JAJAJAJAJAJAJ");
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void instruccion_INNN(){



}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void instruccion_INNC(){


}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void instruccion_OUTN(){


}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void instruccion_CREA(){


}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void instruccion_JOIN(){


}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void instruccion_BLOK(){


}


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void instruccion_XXXX(){

	systemCall = 0; //Se supone que las instrucciones privilegiadas y las que no ,terminan con la instruccion XXXX entonces lo que hago es poner la system = 0 asi la privilegiada sale del while

	cargar_registros_TCB();

	// Envio TCB
	t_contenido mensaje_para_mandar_TCB;
	memset(mensaje_para_mandar_TCB,0,sizeof(t_contenido));
	strcpy(mensaje_para_mandar_TCB,string_from_format("[%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d]",TCB->pid,TCB->tid,TCB->indicador_modo_kernel,TCB->base_segmento_codigo,TCB->tamanio_segmento_codigo,TCB->puntero_instruccion,TCB->base_stack,TCB->cursor_stack,TCB->registros_de_programacion.A,TCB->registros_de_programacion.B,TCB->registros_de_programacion.C,TCB->registros_de_programacion.D,TCB->registros_de_programacion.E));
	enviarMensaje(newFD,CPU_TO_KERNEL_END_PROC,mensaje_para_mandar_TCB,logs);

	log_info(logs,"Bien llego hasta sigaaaaaaaan");
}

////////////////////////////////////////////////////////////////////////////////////////////////////

void instruccion_WAKE(int32_t direccion){



}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void cargar_registros_TCB(){

	// Cargo los registros de programacion del TCB con los valores de los registros de la CPU

		TCB->registros_de_programacion.A = A;
		TCB->registros_de_programacion.B = B;
		TCB->registros_de_programacion.C = C;
		TCB->registros_de_programacion.D = D;
		TCB->registros_de_programacion.E = E;

}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



